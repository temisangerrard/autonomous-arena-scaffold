<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agent Operations</title>
  <link rel="stylesheet" href="/styles.css">
  <script src="/runtime-config.js"></script>
  <style>
    body { margin: 0; }
    .ops {
      min-height: 100vh;
      padding: 16px;
      background: radial-gradient(circle at 0 0, rgba(201, 162, 39, 0.22), transparent 40%), var(--bg-primary);
      color: var(--text-primary);
      font-family: var(--font-primary);
    }
    .ops h1 {
      font: 700 30px/1 var(--font-display);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin: 0 0 16px;
      color: var(--accent-primary);
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 12px;
      margin-bottom: 14px;
    }
    .panel {
      border: 1px solid var(--border-gold);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.92);
      padding: 12px;
      box-shadow: var(--shadow-sm);
    }
    .panel h2 {
      margin: 0 0 10px;
      font: 600 14px/1.2 var(--font-display);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--accent-secondary);
    }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
    .row-1 { margin-bottom: 8px; }
    label {
      display: block;
      font: 11px/1.2 var(--font-mono);
      color: var(--text-secondary);
      margin-bottom: 3px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    input, select, button, textarea {
      width: 100%;
      border-radius: 8px;
      border: 1px solid var(--border-medium);
      background: var(--bg-card);
      color: var(--text-primary);
      padding: 8px;
      font: 13px/1.2 var(--font-primary);
    }
    button { cursor: pointer; }
    button.primary { background: linear-gradient(120deg, var(--gold-primary), var(--gold-dark)); color: #fff; border-color: var(--gold-dark); }
    button.secondary { background: linear-gradient(120deg, #d9c691, var(--gold-light)); border-color: var(--gold-primary); }
    pre {
      margin: 0;
      max-height: 180px;
      overflow: auto;
      padding: 10px;
      border-radius: 8px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-medium);
      color: var(--text-secondary);
      font: 12px/1.35 var(--font-mono);
      white-space: pre-wrap;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      border-bottom: 1px solid var(--border-light);
      padding: 8px 6px;
      text-align: left;
      vertical-align: middle;
    }
    th { color: var(--text-secondary); font-weight: 600; text-transform: uppercase; font-size: 11px; }
    .table-wrap { max-height: 300px; overflow: auto; }
    .actions { display: flex; gap: 6px; }
    .actions button { width: auto; padding: 6px 10px; font-size: 11px; }
  </style>
</head>
<body>
  <main class="ops">
    <h1>Agent Operations</h1>

    <div class="grid">
      <section class="panel">
        <h2>Ops Super Agent (admin only)</h2>
        <div class="row">
          <div>
            <label for="super-id">Super agent id</label>
            <input id="super-id" type="text" value="agent_1">
          </div>
          <div>
            <label for="super-mode">Mode</label>
            <select id="super-mode">
              <option value="balanced">balanced</option>
              <option value="hunter">hunter</option>
              <option value="defensive">defensive</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="super-cooldown">Worker cooldown (ms)</label>
            <input id="super-cooldown" type="number" min="1200" max="120000" value="9000">
          </div>
          <div>
            <label for="super-target">Worker target preference</label>
            <select id="super-target">
              <option value="human_only">human_only</option>
              <option value="human_first">human_first</option>
              <option value="any">any</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label><input id="super-challenge-enabled" type="checkbox" checked> Challenges enabled</label>
          </div>
          <div>
            <label><input id="wallet-enabled" type="checkbox"> Wallet skills enabled</label>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="wallet-skills">Wallet skills (comma separated)</label>
            <input id="wallet-skills" type="text" value="authenticate-wallet,fund,send-usdc,trade,query-onchain-data,solidity-contract-design,solidity-security-review,evm-gas-optimization">
          </div>
          <div>
            <label for="openrouter-key">OpenRouter API key</label>
            <input id="openrouter-key" type="password" placeholder="sk-or-v1-...">
          </div>
        </div>
        <div class="actions">
          <button id="save-super" class="primary">Apply Super Config</button>
          <button id="save-wallet" class="secondary">Apply Wallet Policy</button>
          <button id="save-openrouter">Save OpenRouter</button>
          <button id="sync-ethskills">Sync ETHSkills</button>
          <button id="apply-delegation">Re-run Delegation</button>
        </div>
      </section>

      <section class="panel">
        <h2>Create Profile + Bot + Wallet</h2>
        <div class="row">
          <div>
            <label for="new-username">Username</label>
            <input id="new-username" type="text" placeholder="temi">
          </div>
          <div>
            <label for="new-display-name">Display name</label>
            <input id="new-display-name" type="text" placeholder="Temisan">
          </div>
        </div>
        <div class="row">
          <div>
            <label for="new-personality">Initial personality</label>
            <select id="new-personality">
              <option value="social">social</option>
              <option value="aggressive">aggressive</option>
              <option value="conservative">conservative</option>
            </select>
          </div>
          <div>
            <label for="new-target">Target preference</label>
            <select id="new-target">
              <option value="human_only">human_only</option>
              <option value="human_first">human_first</option>
              <option value="any">any</option>
            </select>
          </div>
        </div>
        <div class="actions">
          <button id="create-profile" class="primary">Create Profile Bundle</button>
          <button id="refresh-all">Refresh</button>
        </div>
      </section>

      <section class="panel">
        <h2>Background Bots</h2>
        <div class="row">
          <div>
            <label for="bg-count">Background bot count</label>
            <input id="bg-count" type="number" min="0" max="60" value="8">
          </div>
          <div style="align-self:end">
            <button id="apply-bg-count">Apply Count</button>
          </div>
        </div>
        <pre id="status-summary">Loading...</pre>
      </section>

      <section class="panel">
        <h2>House Bank</h2>
        <div class="row">
          <div>
            <label>House wallet</label>
            <input id="house-wallet-id" type="text" readonly value="-">
          </div>
          <div>
            <label>House balance</label>
            <input id="house-balance" type="text" readonly value="-">
          </div>
        </div>
        <div class="row">
          <div>
            <label for="house-npc-floor">NPC wallet floor</label>
            <input id="house-npc-floor" type="number" min="0" step="1" value="40">
          </div>
          <div>
            <label for="house-npc-topup">NPC topup amount</label>
            <input id="house-npc-topup" type="number" min="0" step="1" value="20">
          </div>
        </div>
        <div class="row">
          <div>
            <label for="house-super-floor">Super agent floor</label>
            <input id="house-super-floor" type="number" min="0" step="1" value="120">
          </div>
          <div style="align-self:end">
            <button id="house-apply" class="secondary">Apply House Policy</button>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="house-refill-amount">Refill house amount</label>
            <input id="house-refill-amount" type="number" min="1" step="1" value="200">
          </div>
          <div style="align-self:end">
            <button id="house-refill" class="primary">Refill</button>
          </div>
        </div>
        <div class="row">
          <div>
            <label for="house-transfer-wallet">Transfer to walletId</label>
            <input id="house-transfer-wallet" type="text" placeholder="wallet_123">
          </div>
          <div>
            <label for="house-transfer-amount">Amount</label>
            <input id="house-transfer-amount" type="number" min="1" step="1" value="20">
          </div>
        </div>
        <div class="actions">
          <button id="house-transfer" class="primary">Transfer</button>
        </div>
        <pre id="house-ledger">Loading house ledger...</pre>
      </section>
    </div>

    <section class="panel" style="margin-bottom: 12px;">
      <h2>Profiles</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Profile</th>
              <th>Wallet</th>
              <th>Balance</th>
              <th>Bots</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="profiles-body"></tbody>
        </table>
      </div>
    </section>

    <section class="panel" style="margin-bottom: 12px;">
      <h2>Bots</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Owner</th>
              <th>Duty</th>
              <th>Section</th>
              <th>Connected</th>
              <th>Personality</th>
              <th>Target</th>
              <th>Cooldown</th>
              <th>Managed</th>
              <th>Save</th>
            </tr>
          </thead>
          <tbody id="bots-body"></tbody>
        </table>
      </div>
    </section>

    <section class="panel" style="margin-bottom: 12px;">
      <h2>Ops Super Agent Console (admin only)</h2>
      <div class="row-1">
        <label for="super-chat-input">Ask super agent</label>
        <textarea id="super-chat-input" rows="4" placeholder="status | mode hunter | bot count 16 | why are games not starting?"></textarea>
      </div>
      <div class="actions" style="margin-bottom: 8px;">
        <button id="super-chat-send" class="primary">Send Command</button>
        <button id="super-chat-status">Quick Status</button>
      </div>
      <pre id="super-chat-log">Ops Super Agent console ready.</pre>
    </section>

    <section class="panel">
      <h2>Challenge Log</h2>
      <pre id="challenge-log">Loading challenge logs...</pre>
    </section>
  </main>
  <script type="module" src="/js/auth-shell.js"></script>
  <script type="module">
    // Static hosting can serve this page without server-side auth checks.
    // Hard-gate the UI client-side: only admins may stay on this page.
    (async function () {
      try {
        const res = await fetch('/api/session', { credentials: 'include' });
        if (!res.ok) {
          window.location.href = '/welcome';
          return;
        }
        const payload = await res.json().catch(() => ({}));
        const role = payload?.user?.role || '';
        if (role !== 'admin') {
          window.location.href = '/dashboard';
        }
      } catch {
        window.location.href = '/welcome';
      }
    })();
  </script>
  <script src="/js/agents.js" defer></script>
</body>
</html>
