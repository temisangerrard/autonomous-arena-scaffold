<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Train Station Mega World - Interactive 3D Experience</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; overflow: hidden; background: #1a1a2e; }
        #container { width: 100vw; height: 100vh; }

        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 1000; transition: opacity 0.5s ease;
        }
        #loading.hidden { opacity: 0; pointer-events: none; }

        .loader {
            width: 60px; height: 60px; border: 4px solid #0f3460;
            border-top: 4px solid #e94560; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #loading h1 { color: #e94560; margin-top: 20px; font-size: 24px; }
        #loading p { color: #a0a0a0; margin-top: 10px; }

        #progress-bar { width: 200px; height: 6px; background: #0f3460; border-radius: 3px; margin-top: 20px; overflow: hidden; }
        #progress-fill { width: 0%; height: 100%; background: linear-gradient(90deg, #e94560, #ff6b6b); transition: width 0.3s ease; }

        #ui { position: fixed; top: 20px; left: 20px; z-index: 100; }
        #ui h2 { color: #fff; font-size: 28px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        #ui p { color: #ccc; font-size: 14px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }

        #controls {
            position: fixed; bottom: 20px; left: 20px;
            background: rgba(0,0,0,0.7); padding: 15px 20px; border-radius: 10px; color: #fff; z-index: 100;
        }
        #controls h3 { color: #e94560; margin-bottom: 10px; font-size: 14px; }
        #controls p { font-size: 12px; margin: 5px 0; color: #ccc; }
        #controls kbd { background: #333; padding: 2px 6px; border-radius: 3px; font-family: monospace; }

        #npc-info {
            position: fixed; top: 20px; right: 20px;
            background: rgba(0,0,0,0.8); padding: 15px 20px; border-radius: 10px; color: #fff; z-index: 100; max-width: 250px;
        }
        #npc-info h3 { color: #4ecca3; margin-bottom: 10px; }
        .npc-item { display: flex; align-items: center; margin: 8px 0; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 5px; }
        .npc-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 10px; }
        .npc-dot.junipa { background: #ff6b6b; }
        .npc-dot.jogger { background: #4ecdc4; }
        .npc-dot.lumberjack { background: #ffe66d; }
        .npc-dot.robot { background: #95e1d3; }
        .npc-dot.vendor { background: #f9ca24; }
        .npc-dot.guard { background: #6c5ce7; }
        .npc-dot.traveler { background: #00b894; }
    </style>
</head>
<body>
    <div id="loading">
        <div class="loader"></div>
        <h1>Mega World</h1>
        <p>Loading 8 Districts (1238 objects)...</p>
        <div id="progress-bar"><div id="progress-fill"></div></div>
    </div>

    <div id="container"></div>

    <div id="ui">
        <h2>Train Station Mega World</h2>
        <p>8 Districts | 40+ NPCs | 1238 Objects</p>
    </div>

    <div id="controls">
        <h3>CONTROLS</h3>
        <p><kbd>Left Click</kbd> + Drag - Rotate</p>
        <p><kbd>Right Click</kbd> + Drag - Pan</p>
        <p><kbd>Scroll</kbd> - Zoom</p>
        <p><kbd>R</kbd> - Reset view</p>
    </div>

    <div id="npc-info">
        <h3>World Sections (40+ NPCs)</h3>
        <div class="npc-item"><div class="npc-dot junipa"></div><span>Harbor District - 6 NPCs</span></div>
        <div class="npc-item"><div class="npc-dot jogger"></div><span>Residential Village - 5 NPCs</span></div>
        <div class="npc-item"><div class="npc-dot lumberjack"></div><span>Festival Carnival - 6 NPCs</span></div>
        <div class="npc-item"><div class="npc-dot robot"></div><span>Park Recreation - 5 NPCs</span></div>
        <div class="npc-item"><div class="npc-dot vendor"></div><span>Industrial Workshop - 4 NPCs</span></div>
        <div class="npc-item"><div class="npc-dot guard"></div><span>Medieval Castle - 4 NPCs</span></div>
        <div class="npc-item"><div class="npc-dot traveler"></div><span>Farm Fields - 4 NPCs</span></div>
        <div class="npc-item"><div class="npc-dot" style="background:#9b59b6"></div><span>Mystical Grove - 3 NPCs</span></div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';

        // Scene
        const container = document.getElementById('container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB); // Sky blue background

        // Camera
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(100, 80, 100);

        // Renderer
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.outputColorSpace = THREE.SRGBColorSpace;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.0;
        container.appendChild(renderer.domElement);

        // Controls
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.maxPolarAngle = Math.PI / 2.1;
        controls.minDistance = 5;
        controls.maxDistance = 300;
        controls.target.set(0, 0, 0);

        // LIGHTING - Key to showing colors!

        // Ambient light - overall illumination
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        // Main directional light (sun)
        const sunLight = new THREE.DirectionalLight(0xffffff, 1.5);
        sunLight.position.set(50, 100, 50);
        sunLight.castShadow = true;
        sunLight.shadow.mapSize.width = 2048;
        sunLight.shadow.mapSize.height = 2048;
        sunLight.shadow.camera.near = 0.5;
        sunLight.shadow.camera.far = 300;
        sunLight.shadow.camera.left = -100;
        sunLight.shadow.camera.right = 100;
        sunLight.shadow.camera.top = 100;
        sunLight.shadow.camera.bottom = -100;
        scene.add(sunLight);

        // Fill light from opposite side
        const fillLight = new THREE.DirectionalLight(0xffffff, 0.5);
        fillLight.position.set(-30, 50, -30);
        scene.add(fillLight);

        // Hemisphere light for natural outdoor feel
        const hemiLight = new THREE.HemisphereLight(0x87CEEB, 0x556633, 0.5);
        scene.add(hemiLight);

        // Load the GLB model
        const loader = new GLTFLoader();
        const progressFill = document.getElementById('progress-fill');
        const loadingScreen = document.getElementById('loading');

        loader.load(
            'train_station_mega_world.glb',
            function (gltf) {
                const model = gltf.scene;

                // Enable shadows and fix materials
                model.traverse((child) => {
                    if (child.isMesh) {
                        child.castShadow = true;
                        child.receiveShadow = true;

                        // Ensure materials render properly
                        if (child.material) {
                            child.material.needsUpdate = true;
                            // If material is MeshStandardMaterial, ensure it's visible
                            if (child.material.isMeshStandardMaterial) {
                                child.material.metalness = Math.min(child.material.metalness, 0.5);
                                child.material.roughness = Math.max(child.material.roughness, 0.3);
                            }
                        }
                    }
                });

                scene.add(model);

                // Hide loading screen
                setTimeout(() => {
                    loadingScreen.classList.add('hidden');
                }, 500);

                console.log('Model loaded successfully!');
                console.log('Scene children:', scene.children.length);
            },
            function (xhr) {
                if (xhr.total) {
                    const progress = (xhr.loaded / xhr.total) * 100;
                    progressFill.style.width = progress + '%';
                }
            },
            function (error) {
                console.error('Error loading model:', error);
                document.querySelector('#loading p').textContent = 'Error loading model: ' + error.message;
            }
        );

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (event) => {
            if (event.key === 'r' || event.key === 'R') {
                camera.position.set(100, 80, 100);
                controls.target.set(0, 0, 0);
            }
        });
    </script>
</body>
</html>
